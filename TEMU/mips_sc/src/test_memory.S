#include "trap.h"
.set noat
.set noreorder
.globl main
.text
main:
    # ==============================
    # 测试准备: 设置内存基地址
    # ==============================
    lui $s0, 0x8001             # $s0 = 0x80010000 (数据段起始地址)
    
    # ==============================
    # 测试 1: sw/lw 字存储和加载
    # ==============================
    ori $t0, $zero, 0x12345678
    sw $t0, 0($s0)              # [0x80010000] = 0x12345678
    lw $t1, 0($s0)              # $t1 = 0x12345678
    bne $t0, $t1, fail
    nop
    
    # ==============================
    # 测试 2: sw/lw 边界值
    # ==============================
    lui $t2, 0xFFFF
    ori $t2, $t2, 0xFFFF        # $t2 = 0xFFFFFFFF
    sw $t2, 4($s0)              # [0x80010004] = 0xFFFFFFFF
    lw $t3, 4($s0)              # $t3 = 0xFFFFFFFF
    bne $t2, $t3, fail
    nop
    
    # ==============================
    # 测试 3: sw/lw 零值
    # ==============================
    addiu $t4, $zero, 0
    sw $t4, 8($s0)              # [0x80010008] = 0x00000000
    lw $t5, 8($s0)              # $t5 = 0x00000000
    bne $t4, $t5, fail
    nop
    
    # ==============================
    # 测试 4: sb/lb 字节存储和加载 (无符号)
    # ==============================
    ori $t6, $zero, 0x00AB      # $t6 = 0xAB
    sb $t6, 12($s0)             # [0x8001000C] = 0xAB
    lbu $t7, 12($s0)            # $t7 = 0x000000AB (无符号扩展)
    bne $t6, $t7, fail
    nop
    
    # ==============================
    # 测试 5: sb/lb 字节存储和加载 (符号扩展 - 负数)
    # ==============================
    ori $s1, $zero, 0x00FF      # $s1 = 0xFF
    sb $s1, 13($s0)             # [0x8001000D] = 0xFF
    lb $s2, 13($s0)             # $s2 = 0xFFFFFFFF (符号扩展)
    addiu $s3, $zero, -1        # $s3 = 0xFFFFFFFF
    bne $s2, $s3, fail
    nop
    
    # ==============================
    # 测试 6: sb/lb 符号扩展 - 边界值
    # ==============================
    ori $s4, $zero, 0x0080      # $s4 = 0x80 (符号位)
    sb $s4, 14($s0)             # [0x8001000E] = 0x80
    lb $s5, 14($s0)             # $s5 = 0xFFFFFF80 (符号扩展)
    addiu $s6, $zero, -128      # $s6 = -128 = 0xFFFFFF80
    bne $s5, $s6, fail
    nop
    
    # ==============================
    # 测试 7: 内存数据完整性
    # ==============================
    lw $v0, 0($s0)              # 重新读取验证
    lw $v1, 4($s0)
    
    HIT_GOOD_TRAP

fail:
    b fail
    nop